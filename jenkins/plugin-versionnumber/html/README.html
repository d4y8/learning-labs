<h1
id="jenkins-pluginのversion-numberでoverridebuildsalltimeを指定するとインクリメントされない">Jenkins
PluginのVersion
NumberでoverrideBuildsAllTimeを指定するとインクリメントされない</h1>
<p>Jenkins Pluginの Version
Numberで[BUILDS_ALL_TIME]を利用する場合、<br />
<code>overrideBuildsAllTime</code>を指定すると番号がインクリメントされない。</p>
<p>通常、[BUILDS_ALL_TIME]は1から始まる。<br />
これを1ではない数値から始めたい場合、<br />
例えばパイプラインを作り直した際に続きから再開したいといった場合、<br />
<code>overrideBuildsAllTime: 10</code>などと指定することで実現できる。</p>
<p>が、これを指定すると次のビルドでも再び<code>10</code>と採番されてしまう。</p>
<p>解決策としては一度<code>overrideBuildsAllTime</code>を指定して実行したら、<br />
次回以降は<code>overrideBuildsAllTime</code>を削除してしまえば良い。</p>
<h2 id="参考---version-number-plugin">参考 - Version Number Plugin</h2>
<ul>
<li>https://plugins.jenkins.io/versionnumber/</li>
<li>https://www.jenkins.io/doc/pipeline/steps/versionnumber/</li>
</ul>
<h2 id="version-number-pluginバージョン">Version Number
Pluginバージョン</h2>
<ul>
<li>234.v315d3b_3cb_fb_5</li>
</ul>
<h2 id="パイプラインの検証">パイプラインの検証</h2>
<p>Pipelineの定義</p>
<pre class="jenkinsfile"><code>name: Insert post to Google Blogger

on:
  push:
    branches: 
    - main
    paths:
    - &#39;**/*.md&#39;
  workflow_dispatch:

jobs:
  call-blogger-api:
    runs-on: ubuntu-latest
    permissions:
      contents: &#39;write&#39;
    steps:
      - uses: actions/checkout@v4
        with: 
          fetch-depth: 2
      - uses: actions/setup-python@v5
        with:
          python-version: &#39;3.13.1&#39;
      - name: Convert Markdown to HTML
        env:
            GITHUB_EVENT_BEFORE: ${{ github.event.before }}
            # GITHUB_EVENT_REPOSITORY_URL: ${{ github.event.repository.url}}
        run: |
          set -eux
          env
          sudo apt-get install -y pandoc
          pip install --user pandoc-include

          diff_list=$(git diff --name-only ${GITHUB_EVENT_BEFORE}..HEAD)

          for file in $diff_list; do
            if [[ ${file} != *.md ]]; then
              continue
            fi
            
            dir_name=$(dirname ${file})
            html_dir=${dir_name}/html
            mkdir -p ${html_dir}

            # md -&gt; html変換
            html_file=${html_dir}/$(basename &quot;${file}&quot; .md).html
            # pandoc -f markdown -t html &quot;${file}&quot; &gt; ${html_file}
            pandoc -f markdown -t html --filter pandoc-include &quot;${file}&quot; &gt; ${html_file}

            # img パス置換
            # https://github.com/d4y8/learning-labs/blob/main/jenkins/plugin-versionnumber/README-images
            # ↓
            # https://github.com/d4y8/learning-labs/blob/main/&lt;MARKDOWN_DIR_PATH&gt;/README-images

            before_path=&quot;\.\/README-images&quot;

            after_path=&quot;${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/main/${dir_name}/README-images&quot;
            after_path=${after_path//\//\\/}
            after_path=${after_path//./\\.}
            after_path=${after_path//\?/\\\?}

            sed -i &#39;s/&#39;${before_path}&#39;/&#39;${after_path}&#39;/g&#39; ${html_file}

            before_string=&quot;\.png\&quot;&quot;
            after_string=&quot;\.png\?raw=true\&quot;&quot;

            sed -i &#39;s/&#39;${before_string}&#39;/&#39;${after_string}&#39;/g&#39; ${html_file}

            cat ${html_file}
            echo ${html_file} &gt;&gt; html.txt
          done

          if [[ -n ${html_file} ]]; then
            git config user.name  &quot;actions-user&quot;
            git config user.email &quot;action@github.com&quot;
            git add **/*.html
            git commit -m &quot;Converted Markdown to HTML&quot;
            git push
          fi

      - name: Set up authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Install dependencies
        run: pip install google-api-python-client

      - name: Call Blogger API
        env: 
          BLOG_ID: ${{ secrets.BLOG_ID }}
        run: |
          python .github/scripts/blog_post.py
</code></pre>
<p>!include jenkins/plugin-versionnumber/Jenkinsfile</p>
<p><code>overrideBuildsAllTime: 10</code>を指定して実行。<br />
意図通り10と採番される。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/jenkins/plugin-versionnumber/README-images/version-number-output-1.png?raw=true"></p>
<p>もう一度ビルド実行する。</p>
<p>すると、インクリメントされず前回と同じ番号となる。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/jenkins/plugin-versionnumber/README-images/version-number-output-2.png?raw=true"></p>
<p>回避策としてoverrideBuildsAllTimeを削除し、ビルド実行する。</p>
<pre class="jenkinsfile"><code>VERION_NUMBER = VersionNumber(versionNumberString: &#39;1.0.0+${BUILDS_ALL_TIME}&#39;)</code></pre>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/jenkins/plugin-versionnumber/README-images/version-number-output-3.png?raw=true"></p>
<p>続きの11にインクリメントされることが確認できた。</p>
