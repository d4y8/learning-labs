<h1
id="github-actionsからgoogle-bloggerに完全自動ポストできるか検証する">GitHub
ActionsからGoogle Bloggerに完全自動ポストできるか検証する</h1>
<h2 id="結論から先に">結論から先に</h2>
<p>Service Accountで認証する場合、Google
Bloggerへポストする権限がなく、完全自動化はできない。</p>
<h2 id="自動化しようとした背景">自動化しようとした背景</h2>
<p>WordPressで運用していたブログをGoogle
Bloggerにマイグレーションした際、
移行ツールはあるものの結構手間だった。特に画像の移行。
なので今後ブログサーバーの移行があっても楽できるように
ブログのリソース(記事、画像)はGitHubで管理、ついでに諸々自動化できたらというのが動機。</p>
<h2 id="やりたいこと">やりたいこと</h2>
<ul>
<li>ブログのリソース(記事や画像)はGitHubで管理したい。</li>
<li>記事はMarkdownで書きたい。</li>
<li>リポジトリにPushしたらGitHub
ActionsでBloggerに自動で投稿したい。</li>
</ul>
<h2 id="事前準備">事前準備</h2>
<p>Google Blogger
APIを利用するにあたり、認証に必要な設定をしておく。</p>
<h3 id="google-cloud設定">Google Cloud設定</h3>
<p>Google BloggerのアカウントでGoogle
Cloudのプロジェクトは作成済みであることを前提とする。</p>
<h4 id="blogger-apiの有効化">Blogger APIの有効化</h4>
<p>作成済みのGoogle Cloudのプロジェクトで、Blogger APIを有効する。
Google Cloud Consoleの[APIとサービス] &gt; [ライブラリ]で[Blogger
API]を検索。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/blog-cicd/README-images/gc-api-library-google-blogger.png?raw=true" width="80%"></p>
<p>有効にする。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/blog-cicd/README-images/gc-api-library-google-blogger-describe.png?raw=true" width="80%"></p>
<h4 id="service-accountの作成">Service Accountの作成</h4>
<p>GitHub ActionsからBlogger
APIにアクセスするために、サービスアカウントを作成。</p>
<p>Google Cloud Consoleの[IAMと管理] &gt;
[サービスアカウント]で、新しいサービスアカウントを作成。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/blog-cicd/README-images/gc-create-service-account.png?raw=true" width="80%"></p>
<h4 id="キーの作成">キーの作成</h4>
<p>サービスアカウントの認証に使用するJSON形式のキーを作成。 Google Cloud
Consoleのサービスアカウントの詳細ページで、[鍵]タブを選択し、
[キーを追加] &gt;
[新しい鍵を作成]を選択。キーのタイプは[JSON]を選択し[作成]。
キーファイルがダウンロードされる。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/blog-cicd/README-images/gc-create-service-account-key.png?raw=true" width="80%"></p>
<h3
id="githubリポジトリへのシークレット登録">GitHubリポジトリへのシークレット登録</h3>
<p>作成したサービスアカウントキーの内容を、GitHubリポジトリのシークレットとして登録。
リポジトリの[Settings] &gt; [Secrets and variables] &gt;
[Actions]で、[New repository secret]押下し、
[Name]と[Secret]（サービスアカウントキーファイルの内容）を入力して保存。</p>
<p><img src="https://github.com/d4y8/learning-labs/blob/main/blog-cicd/README-images/github-secret-settings.png?raw=true" width="80%"></p>
<h2 id="github-actionsのワークフロー作成">GitHub
Actionsのワークフロー作成</h2>
<h3 id="ざっくりとしたフロー">ざっくりとしたフロー</h3>
<ol type="1">
<li>mainブランチへのプッシュで起動</li>
<li>Gitリポジトリをcheckout</li>
<li>commitしたmdをhtmlへ変換</li>
<li>Google Cloud認証</li>
<li>htmlをGoogle BloggerへPost</li>
</ol>
<h3 id="md---html変換">md -&gt; html変換</h3>
<p><a
href="https://pandoc-doc-ja.readthedocs.io/ja/latest/users-guide.html">pandoc</a>を利用する。</p>
<h3 id="github-actions-から-google-cloud-への認証">GitHub Actions から
Google Cloud への認証</h3>
<p><a
href="https://github.com/google-github-actions/auth?tab=readme-ov-file#service-account-key-json">google-github-actions/auth</a>でService
Account Key Jsonでの認証を利用する。</p>
<h3 id="実装内容">実装内容</h3>
<p>.github/workflows/insert-post-to-google-blogger.yaml</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">!include &quot;.github/workflows/insert-post-to-google-blogger.yaml&quot;</span></span></code></pre></div>
<p>.github/scripts/blog_post.py</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>include <span class="st">&quot;.github/scripts/blog_post.py&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>!include &quot;html/README.html&quot;</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>!include html/README.html</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>!include &quot;./html/README.html&quot;</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>!include &quot;blog-cicd/html/README.html&quot;</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>!include &quot;/home/runner/work/learning-labs/blog-cicd/html/README.html&quot;</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>!include /home/runner/work/learning-labs/blog-cicd/html/README.html</span></code></pre></div>
<h3 id="github-actionsが実行されるとbloggerへの投稿時に403エラー">GitHub
Actionsが実行されると、Bloggerへの投稿時に403エラー</h3>
<p>エラー内容</p>
<pre class="log"><code>&lt;HttpError 403 when requesting https://blogger.googleapis.com/v3/blogs/***/posts?alt=json returned &quot;We&#39;re sorry, but you don&#39;t have permission to access this resource.&quot;. Details: &quot;[***&#39;message&#39;: &quot;We&#39;re sorry, but you don&#39;t have permission to access this resource.&quot;, &#39;domain&#39;: &#39;global&#39;, &#39;reason&#39;: &#39;forbidden&#39;***]&quot;&gt;</code></pre>
<h4 id="原因">原因</h4>
<p>Service AccountではGoogle Bloggerに記事を投稿する権限はない。</p>
<h4 id="対策検討">対策(検討)</h4>
<p>なし、、、HTMLファイルをリポジトリの保存して、それをGoogle
Bloggerに手動更新する。</p>
<h3 id="今後やれたら">今後やれたら</h3>
<p>Textlint、Google Search
Console、SNSポスト辺りも自動化できたら良い。</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>その他、発生したエラーと対処。</p>
<h3 id="git-diff-実行時にエラー">git diff 実行時にエラー</h3>
<p>GitHub
Actionsのジョブにて以下のように<code>git diff</code>したところエラーとなった。</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> diff <span class="at">--name-only</span> <span class="va">${</span><span class="er">{ github.event.before </span><span class="va">}</span>}..HEAD<span class="er">)</span></span></code></pre></div>
<pre class="log"><code>fatal: Invalid revision range ef1dd6de85606d4627addee932fd51ba7bff9e7d..HEAD
Error: Process completed with exit code 128.</code></pre>
<h4 id="原因-1">原因</h4>
<p>actions/checkoutの<code>fetch-depth</code>のデフォルトは<code>1</code>で、
その場合、最新の履歴のみフェッチされ一つ前の履歴はfetchされていないから。</p>
<p>https://github.com/actions/checkout?tab=readme-ov-file#usage</p>
<h4 id="解決方法">解決方法</h4>
<p><code>fetch-depth</code>を<code>2</code>に変更</p>
<p>###　GitHub Actionsでgit push</p>
<pre class="log"><code>remote: Permission to d4y8/learning-labs.git denied to github-actions[bot].
fatal: unable to access &#39;https://github.com/d4y8/learning-labs/&#39;: The requested URL returned error: 403</code></pre>
<h4 id="原因-2">原因</h4>
<p>ジョブがコンテンツへの書き込み権限を持っていないため。</p>
<h4 id="解決方法-1">解決方法</h4>
<p>ジョブに書き込み権限を付与する。</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">call-blogger-api</span><span class="kw">:</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">contents</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;write&#39;</span><span class="co"> #追加</span></span></code></pre></div>
<p>リポジトリ内のすべてのワークフローに共通して設定する場合は以下でもOK。</p>
<p>[Settings] &gt; [Actions] &gt; [General] &gt; [Workflow permissions]
<code>Read and write permissions</code>を選択して[Save]。</p>
